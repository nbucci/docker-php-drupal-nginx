FROM nginx:1.17.6-alpine

ARG user=root

LABEL org.opencontainers.image.source https://github.com/sparkfabrik/docker-php-drupal-nginx/tree/feature/d8

COPY --chown=$user:$user docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh && \
    chown -R $user:$user /etc/nginx && \
    chown -R $user:$user /var/cache/nginx && \
    chown -R $user:$user /var/log/nginx && \
    mkdir /var/run/nginx && \
    chown -R $user:$user /var/run/nginx && \
    sed -i 's|/var/run/nginx.pid|/var/run/nginx/nginx.pid|g' /etc/nginx/nginx.conf

COPY --chown=$user:$user templates /templates
COPY --chown=$user:$user config/custom.conf /etc/nginx/conf.d/custom.conf

# Go to target user
USER $user

ENTRYPOINT [ "/docker-entrypoint.sh" ]
